<!DOCTYPE html>
<html>

<head>
	<meta charset="utf-8">
	<title>Elförbrukning - historik</title>
	<script src="https://englund.mooo.com/static/stock/Chart.js"></script>
</head>

<body>
	<h1>Elförbrukning</h1>
	<div id="valuediv">
		<canvas id="valuechart"></canvas>
	</div>
	<button onclick="fetchData();">Reload</button>
	<a href="https://englund.mooo.com/han/phases.html">Effekt per fas</a>
	<a href="https://englund.mooo.com/han/">Index</a>
</body>


<script>
	var valueChart = null

	var anders
	function redraw(array) {

		now = new Date()
		msEpoch = now.getTime()

		data = {
			datasets: [{
				data: array,
				label: 'Power in kW',
				borderColor: 'rgb(255, 192, 192)',
			}],
			labels: array.map((x, i) => new Date(msEpoch - (array.length - i) * 10000).toISOString().substr(11, 8))
		}

		if (valueChart != null) {
			valueChart.data = data
			valueChart.update()
		} else {
			var ctx = document.getElementById("valuechart").getContext('2d');
			var cfg = {
				type: 'line',
				data: data,
				options: {
					responsive: true,
					legend: {
						display: false
					},
					animation: {
						duration: 0
					},
					scales: {
						xAxes: [],
						yAxes: [{
							position: 'left',
							id: 'y-axis-value',
							scaleLabel: {
								display: true,
								labelString: 'Power [kW]'
							}
						}]
					}
				}
			};
			valueChart = new Chart(ctx, cfg);
		}
	}

	function redrawBinary(response) {
		const arrayBuffer = response;
		if (arrayBuffer) {
			const uintArray = new Uint16Array(arrayBuffer);
			redraw(Array.from(uintArray).map(x => x / 1000))
		};
	}

	function fetchData(params) {
		// Fetch the binary contents and draw the chart.
		var url = "https://englund.mooo.com/han/history/full"

		fetch(url)
			.then(resp => resp.blob())
			.then(blob => blob.arrayBuffer())
			.then(redrawBinary);
	}

	fetchData();


</script>

</html>